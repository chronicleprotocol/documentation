---
sidebar_position: 4
description: Upgrading a Chronicle validator.
keywords: [upgrade, validator]
---

# Upgrading a Validator

How to perform an upgrade on a validator

Helm Chart details:

![Dynamic YAML Badge](https://img.shields.io/badge/dynamic/yaml?url=https%3A%2F%2Fchronicleprotocol.github.io%2Fcharts%2Findex.yaml&query=%24.entries.validator%5B0%5D.version&label=Validator%20ChartVersion&color=green)

<div class="artifacthub-widget" data-url="https://artifacthub.io/packages/helm/chronicle/validator" data-theme="light" data-header="true" data-stars="true" data-responsive="true"><blockquote><p lang="en" dir="ltr"><b>validator</b>: A Helm chart for deploying Chronicle Validator on Kubernetes</p>&mdash; Open in <a href="https://artifacthub.io/packages/helm/chronicle/validator">Artifact Hub</a></blockquote></div><script async src="https://artifacthub.io/artifacthub-widget.js"></script>

<br/>

### Install CRD's

Starting from Chart Version 0.3.4, tor is deployed using the `tor-controller` operator, which installs some [custom resource definitions](kubectl apply -f https://raw.githubusercontent.com/chronicleprotocol/charts/validator-0.3.4/charts/validator/crds/tor-controller.yaml). The controller will create a new onion key, which will be persisted as a secret. Please delete your previous secrets containing the tor keys, as they won't be needed. Retrieve the Ghost onion address using `kubectl get onion -n <namespace>` and notify the Chronicle team of your ETH address and the new Ghost onion address.

If you are running an upgrade from a prior release, chances are that Tor Custom Resource Definitions havent been installed. Helm does not like installing CRD's during a helm upgrade, so we need to manually apply the CRD's like this:


```
kubectl apply -f https://raw.githubusercontent.com/chronicleprotocol/charts/validator-0.3.4/charts/validator/crds/tor-controller.yaml
```

It can take a few moments for the tor-controller to be in a ready state, but please make sure its running before ugprading your validator:

```
kubectl get pods -n tor-controller-system
```

You should see something like this:
```
NAME                                                 READY   STATUS    RESTARTS   AGE
tor-controller-controller-manager-6648f44cc8-g6c68   2/2     Running   0          16m
```

We now have the CRD's deployed (ie `kubectl get crds` will show the tor custom resource definitions), and our values.yaml updated, we can perform the upgrade:

<details>
<summary>Upgrading manually (`helm upgrade`)</summary>

## Upgrading manually (`helm upgrade`)
If you are upgrading from 0.3.x to 0.3.y, simply updating the chart version will suffice:

```
ssh <SERVER_IP>
su - <FEED_USERNAME>
export FEED_NAME=my-feed
```
### Prepare values

The values.yaml file is used to configure the validator. The file is generated by the install script, and should be updated to reflect the latest version of the feed chart.

With the latest version of the chart, there are a few changes that need to be made to the `values.yaml` / `generated-values.yaml` file:

:::warning
- `musig` is now embedded in the `ghost` deployment, and all `.Values.musig` can be removed from the values.yaml file
- Please remove `.Values.ghost.env.CFG_WEB_URL` from your values, as this will be dynamically referenced in the [Ghost deployment spec](https://github.com/chronicleprotocol/charts/blob/main/charts/validator/templates/deployment.yaml#L87-L91).
:::

Please structure your helm values like this:

```yaml
ghost:
  ethConfig:
    ethFrom:
      existingSecret: '<somesecret>'
      key: "ethFrom"
    ethKeys:
      existingSecret: '<somesecret>'
      key: "ethKeyStore"
    ethPass:
      existingSecret: '<somesecret>'
      key: "ethPass"

  env:
    normal:
      CFG_LIBP2P_EXTERNAL_ADDR: '/ip4/1.2.3.4' # public/reachable ip address of node

  ethRpcUrl: "https://MY_L1_RPC_URL"
  rpcUrl: "https://MY_L1_RPC_URL"

```
:::danger
Please ensure your values yaml file is updated to reflect the latest requirements for the validator chart, with the correct values for `ethConfig`, `ethRpcUrl` and `rpcUrl`.
:::

:::danger
Make sure the [TOR crds](#install-crds) are installed.
:::

```
helm repo update
helm upgrade $FEED_NAME -n $FEED_NAME -f $HOME/$FEED_NAME/generated-values.yaml chronicle/validator --version 0.3.4
```
</details>

:::danger
If upgrading from 0.2.x to 0.3.x, please use the helper script, or manually update your `generated-values.yaml` as per the steps above
:::

<details>
<summary>Upgrading using the helper script (`upgrade.sh`)</summary>

## Upgrading using `upgrade.sh`

:::warning
Please be aware that the latest helm chart has been renamed from `feed` to `validator`. Please use the `upgrade.sh` script to upgrade your validator to the latest version. This version embeds `musig` into the `ghost` pod. The upgrader script will clean up the generated `values.yaml` file and remove the unecessary musig values.
:::

To simplify the upgrade process, we have created a helper script that will upgrade your validator to the latest version. 

This script will attempt to run `helm upgrade <feedname> -n <feedname> chronicle/validator` on your feed release, with any updated input variables.

:::caution
Please use the correct `FEED_NAME`, which should be the same as your helm release name, if deployed using the `install.sh` script previously
:::


```
ssh <SERVER_IP>
su - <FEED_USERNAME>
export FEED_NAME=my-feed
```

:::danger
Make sure the [TOR crds](#install-crds) are installed.
:::

### Download the latest `upgrade.sh`

Get the latest upgrade.sh script:
```
wget -N https://raw.githubusercontent.com/chronicleprotocol/scripts/main/feeds/k3s-install/upgrade.sh
chmod a+x upgrade.sh
./upgrade.sh
```

:::tip You can set the expected variables in the `.env` file, or export them as environment variables. If the script fails to find any of these values, it will prompt you for them when running the script.
:::

</details>
---

:::tip
If `kubectl/helm` commands fail, please ensure you have `$KUBECONFIG` set correctly. Take a look [here](quickstart#kubectl--helm-commands-fail) for more detail
:::


## Verify the helm release and version

Verify the chart version has changed and matches what the latest feed version:

```
helm list -n $FEED_NAME
NAME     	NAMESPACE	REVISION	UPDATED                                	STATUS  	CHART          	APP VERSION
validator	validator	3       	2024-04-30 18:49:58.843309576 +0000 UTC	deployed	validator-0.3.4	0.37.2   
```

#### View all resources created in the namespace
```bash
kubectl  get pods,deployment,service,secrets,onion -n demo
NAME                                   READY   STATUS    RESTARTS   AGE
pod/ghost-tor-daemon-b77466d7f-flnm7   1/1     Running   0          4m28s
pod/ghost-77b46586d5-fdcgm             1/1     Running   0          4m29s

NAME                               READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/ghost-tor-daemon   1/1     1            1           4m28s
deployment.apps/ghost              1/1     1            1           4m30s

NAME                            TYPE           CLUSTER-IP     EXTERNAL-IP      PORT(S)                                        AGE
service/ghost-tor-svc           ClusterIP      10.43.197.59   <none>           8888/TCP                                       4m28s
service/ghost-tor-metrics-svc   ClusterIP      10.43.85.148   <none>           9035/TCP                                       4m28s
service/ghost                   LoadBalancer   10.43.21.41    64.46.13.31      8000:31359/TCP,9100:32481/TCP,8080:30963/TCP   4m30s

NAME                                TYPE                                           DATA   AGE
secret/<somesecret>                Opaque                                         3      5m2s
secret/ghost-tor-auth               tor.k8s.torproject.org/authorized-clients-v3   0      4m29s
secret/ghost-tor-secret             tor.k8s.torproject.org/onion-v3                5      4m29s
secret/sh.helm.release.v1.demo.v1   helm.sh/release.v1                             1      4m30s

NAME                                        HOSTNAME                                                         AGE
onionservice.tor.k8s.torproject.org/ghost   areallylongonaddressescreatedformebythetorcontrollercrd.onion    4m30s
```
#### View pod logs:

```bash
kubectl logs -n demo deployment/ghost
kubectl logs -n demo deployment/ghost-tor-daemon
```

and you're done!

:::warning
If you encounter any issues please refer to the [Trouble Shooting](troubleshooting) docs
:::